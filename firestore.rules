rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow anyone to read pricing data
    match /pricing/{document} {
      allow read: if true;
      allow write: if true;
      allow update: if true;
      allow delete: if true;
    }

    // Allow order creation (customers can create orders anonymously)
    // Secure read/update access - only admins or order owner can access
    match /orders/{orderId} {
      allow create: if true; // Allow anonymous order creation
      
      // Allow read if:
      // 1. User is admin, OR
      // 2. User's email matches the order's customer email
      allow read: if request.auth != null && 
        (request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'] ||
         (resource.data.customerInfo != null && 
          resource.data.customerInfo.email == request.auth.token.email));
      
      // Only admins can update orders
      allow update: if request.auth != null && 
        request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'];
      
      // Only admins can delete orders
      allow delete: if request.auth != null && 
        request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'];
    }

    // Admin profiles: each authenticated user can read/write their own profile
    match /adminProfiles/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Append-only internal notes for admin orders
    match /orders/{orderId}/internalNotes/{noteId} {
      // Only authenticated users can read and add notes
      allow read: if request.auth != null;
      allow create: if request.auth != null;

      // Prevent editing or deleting existing notes
      allow update, delete: if false;
    }

    // Allow anyone to read static content
    match /content/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Allow anonymous access to counters for order number generation
    match /counters/{document} {
      allow read, write: if true; // Allow anonymous access for order numbering
    }

    // Allow reading country popularity data for testing
    match /countryPopularity/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Allow creating contact messages anonymously
    match /contactMessages/{document} {
      allow create: if true;
      allow read: if request.auth != null;
    }

    // Allow admin access to invoices
    match /invoices/{invoiceId} {
      allow read: if request.auth != null && request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'];
      allow write: if request.auth != null && request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'];
      allow create: if request.auth != null && request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'];
      allow update: if request.auth != null && request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'];
      allow delete: if request.auth != null && request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'];
    }

    // Allow creating and reading customer emails for order confirmations
    match /customerEmails/{emailId} {
      allow create: if true; // Allow anyone to create customer emails
      allow read: if request.auth != null; // Only authenticated users can read
      allow update, delete: if false; // No updates or deletes allowed
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Secure storage access - authenticated users only
    match /orders/{orderId}/{allPaths=**} {
      // Allow read if user is admin or owns the order
      allow read: if request.auth != null;
      
      // Allow write for authenticated users (for uploads)
      allow write: if request.auth != null;
    }
    
    // Public assets (logos, images, etc.)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && 
        request.auth.token.email in ['admin@legaliseringstjanst.se', 'sofia@sofia.se'];
    }
    
    // Default deny for everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
