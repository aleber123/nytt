rules_version = '2';
 
service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@legaliseringstjanst.se',
               'sofia@sofia.se'
             ];
    }

    // PRICING – public read, only admin may change
    match /pricing/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // CONTENT – static content
    match /content/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // COUNTRY POPULARITY – statistics, not sensitive
    match /countryPopularity/{doc} {
      allow read: if true;
      allow write: if true;
    }

    // ORDERS – customers create, admin UI and backend read/update via hybridOrderService
    match /orders/{orderId} {
      // Allow anyone (even anonymous) to create an order
      allow create: if true;

      // Allow reads and updates (needed because hybridOrderService runs without Firebase Auth)
      // NOTE: This means anyone with the API key can read/update orders.
      // When we refactor to use authenticated admin access or Admin SDK, we can tighten this again.
      allow read, update: if true;

      // Never allow client-side delete
      allow delete: if false;
    }

    // INTERNAL ADMIN NOTES – append-only, admin only
    match /orders/{orderId}/internalNotes/{noteId} {
      allow read, create: if isAdmin();
      allow update, delete: if false;
    }

    match /orderConfirmations/{token} {
      allow create: if true;
      allow read: if true;
      allow update, delete: if isAdmin();
    }

    // COUNTERS – order/invoice counters
    match /counters/{name} {
      allow read: if true;

      // Allow creating a counter document with currentCount and lastUpdated
      allow create: if
        request.resource.data.keys().hasOnly(['currentCount', 'lastUpdated']) &&
        request.resource.data.currentCount is int &&
        request.resource.data.currentCount >= 0;

      // Allow updating only by increasing currentCount
      allow update: if
        request.resource.data.keys().hasOnly(['currentCount', 'lastUpdated']) &&
        resource.data.currentCount is int &&
        request.resource.data.currentCount is int &&
        request.resource.data.currentCount >= resource.data.currentCount;

      allow delete: if false;
    }

    // CONTACT MESSAGES – created anonymously, readable by admin
    match /contactMessages/{msgId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // Helper: internal business notification email queued from Step 10
    function isBusinessQueueEmail() {
      return
        request.resource.data.keys().hasOnly(['name', 'email', 'subject', 'message', 'createdAt', 'status']) &&
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.subject is string &&
        request.resource.data.message is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.status == 'queued' &&
        // Business notifications should always go to the internal inboxes
        request.resource.data.email == 'info@doxvl.se,info@visumpartner.se';
    }

    // Helper: customer confirmation email queued from Step 10
    function isCustomerQueueEmail() {
      return
        request.resource.data.keys().hasOnly(['name', 'email', 'phone', 'subject', 'message', 'orderId', 'createdAt', 'status']) &&
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.phone is string &&
        request.resource.data.subject is string &&
        request.resource.data.message is string &&
        request.resource.data.orderId is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.status == 'unread';
    }

    // CUSTOMER EMAIL QUEUE – created from frontend, processed by Cloud Function
    match /customerEmails/{emailId} {
      // Only allow well-formed documents used by the application
      allow create: if isBusinessQueueEmail() || isCustomerQueueEmail();
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // INVOICES – admin only
    match /invoices/{invoiceId} {
      allow read, write: if isAdmin();
    }

    // EMAIL QUEUE – admin-created, for invoice and pickup label emails
    match /emailQueue/{emailId} {
      allow read, write: if isAdmin();
    }

    // ADMIN PROFILES – each admin can read/write their own profile
    match /adminProfiles/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {

    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@legaliseringstjanst.se',
               'sofia@sofia.se'
             ];
    }

    // Document uploads for orders – PDFs/images up to 20MB
    match /documents/{fileName} {
      // Allow uploads of PDFs/images up to 20 MB from anyone
      allow write: if
        request.resource.size < 20 * 1024 * 1024 &&
        request.resource.contentType.matches('^(image/.*|application/pdf)$');

      // Allow read for anyone with the URL
      // (we can tighten this later if you change how downloads work)
      allow read: if true;
    }

    // Optional admin folder
    match /admin/{allPaths=**} {
      allow read, write: if isAdmin();
    }

    // Block everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

