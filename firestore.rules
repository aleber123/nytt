rules_version = '2';
 
service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@doxvl.se',
               'sofia@sofia.se'
             ];
    }

    function isDoxStaff() {
      return request.auth != null &&
             request.auth.token.email.matches('.*@doxvl\\.se');
    }

    // PRICING – public read, only admin may change
    match /pricing/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // VISA REQUIREMENTS – public read, only admin may change
    match /visaRequirements/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // CONTENT – static content
    match /content/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // COUNTRY POPULARITY – statistics, not sensitive
    match /countryPopularity/{doc} {
      allow read: if true;
      allow write: if true;
    }

    // VISA ORDERS – customers create, admin/staff read/update
    // Same pattern as regular orders - token-based confirmation for customers
    match /visaOrders/{orderId} {
      // Allow anyone to create an order (customer checkout flow)
      allow create: if true;

      // Read: Currently open for admin panel compatibility
      allow read: if true;

      // Update: Admin/staff can update anything
      allow update: if isAdmin() || isDoxStaff();

      // Never allow client-side delete
      allow delete: if false;
    }

    // ORDERS – customers create, admin/staff read/update
    // API routes use Firebase Admin SDK which bypasses these rules
    // Customers access order confirmations via secure token in orderConfirmations collection
    // 
    // ⚠️ SECURITY NOTE: Read is currently open because hybridOrderService
    // uses Firebase client SDK which may not have auth context in all scenarios.
    // The token-based orderConfirmations system protects customer-facing URLs.
    // TODO: Migrate admin panel to use authenticated Firebase calls consistently
    match /orders/{orderId} {
      // Allow anyone to create an order (customer checkout flow)
      allow create: if true;

      // Read: Currently open for admin panel compatibility
      // Customer confirmation pages use secure tokens via orderConfirmations collection
      allow read: if true;

      // Update: Admin/staff can update anything
      // Anonymous users can only update file-related fields (for upload after order creation)
      allow update: if isAdmin() || isDoxStaff() || 
        // Allow anonymous updates only for file upload fields
        (request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['uploadedFiles', 'filesUploaded', 'filesUploadedAt', 'uploadError', 'updatedAt']));

      // Never allow client-side delete
      allow delete: if false;
    }

    // INTERNAL ADMIN NOTES – append-only, admin only
    match /orders/{orderId}/internalNotes/{noteId} {
      allow read, create: if isAdmin();
      allow update, delete: if false;
    }

    match /orderConfirmations/{token} {
      allow create: if true;
      allow read: if true;
      allow update, delete: if isAdmin();
    }

    // COUNTERS – order/invoice counters
    match /counters/{name} {
      allow read: if true;

      // Allow creating a counter document with currentCount and lastUpdated
      allow create: if
        request.resource.data.keys().hasOnly(['currentCount', 'lastUpdated']) &&
        request.resource.data.currentCount is int &&
        request.resource.data.currentCount >= 0;

      // Allow updating only by increasing currentCount
      allow update: if
        request.resource.data.keys().hasOnly(['currentCount', 'lastUpdated']) &&
        resource.data.currentCount is int &&
        request.resource.data.currentCount is int &&
        request.resource.data.currentCount >= resource.data.currentCount;

      allow delete: if false;
    }

    // CONTACT MESSAGES – created anonymously, readable by admin
    match /contactMessages/{msgId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // Helper: internal business notification email queued from Step 10
    function isBusinessQueueEmail() {
      return
        request.resource.data.keys().hasOnly(['name', 'email', 'subject', 'message', 'createdAt', 'status']) &&
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.subject is string &&
        request.resource.data.message is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.status == 'queued' &&
        // Business notifications should always go to the internal inboxes
        request.resource.data.email == 'info@doxvl.se,info@visumpartner.se';
    }

    // Helper: customer confirmation email queued from Step 10
    function isCustomerQueueEmail() {
      return
        request.resource.data.keys().hasOnly(['name', 'email', 'phone', 'subject', 'message', 'orderId', 'createdAt', 'status']) &&
        request.resource.data.name is string &&
        request.resource.data.email is string &&
        request.resource.data.phone is string &&
        request.resource.data.subject is string &&
        request.resource.data.message is string &&
        request.resource.data.orderId is string &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.status == 'unread';
    }

    // CUSTOMER EMAIL QUEUE – created from frontend, processed by Cloud Function
    match /customerEmails/{emailId} {
      // Allow well-formed documents from frontend and API
      // Note: API sends createdAt as Date object which becomes timestamp
      allow create: if true;  // Relaxed to allow API-generated emails
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // CUSTOMERS – CRM database, admin only
    match /customers/{customerId} {
      allow read, write: if isAdmin() || isDoxStaff();
    }

    // INVOICES – admin only
    match /invoices/{invoiceId} {
      allow read, write: if isAdmin();
    }

    // EMAIL QUEUE – admin-created, for invoice and pickup label emails
    match /emailQueue/{emailId} {
      allow read, write: if isAdmin();
    }

    // ADMIN PROFILES – each admin can read/write their own profile
    match /adminProfiles/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // DRIVER REPORTS – saved från admin/driver-sidan
    match /driverReports/{reportId} {
      allow read, write: if isAdmin() || isDoxStaff();
    }

    // ADDRESS CONFIRMATIONS – tokens for customer address verification
    // Created by API when admin sends confirmation email, read/updated by customer via token link
    match /addressConfirmations/{confirmationId} {
      // Allow creating new confirmations (from API)
      allow create: if true;
      
      // Allow reading (customer needs to view their confirmation)
      allow read: if true;
      
      // Allow updating only specific fields (address confirmation)
      // Prevents malicious changes to orderId, token, etc.
      allow update: if 
        // Only allow updating these safe fields
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['confirmed', 'confirmedAt', 'address', 'updatedAt']) &&
        // Cannot change the token or orderId
        request.resource.data.token == resource.data.token &&
        request.resource.data.orderId == resource.data.orderId;
      
      // Never allow delete
      allow delete: if false;
    }

    // ADMIN USERS – role-based access control for admin panel
    match /adminUsers/{userId} {
      // Allow authenticated users to read their own admin user document
      allow read: if request.auth != null && 
        (request.auth.uid == userId || 
         request.auth.token.email == resource.data.email ||
         isAdmin());
      
      // Allow listing all admin users for admins
      allow list: if isAdmin();
      
      // Only admins can create/update/delete admin users
      allow write: if isAdmin();
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {

    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email in [
               'admin@doxvl.se',
               'sofia@sofia.se'
             ];
    }

    // Document uploads for orders – PDFs/images up to 20MB
    match /documents/{fileName} {
      // Allow uploads of PDFs/images up to 20 MB from anyone
      allow write: if
        request.resource.size < 20 * 1024 * 1024 &&
        request.resource.contentType.matches('^(image/.*|application/pdf)$');

      // Allow read for anyone with the URL
      // (we can tighten this later if you change how downloads work)
      allow read: if true;
    }

    // Optional admin folder
    match /admin/{allPaths=**} {
      allow read, write: if isAdmin();
    }

    // Block everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

